<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>My Account - Heartsnaps</title>

    <!-- Google Analytics -->
    <script async src="https://www.googletagmanager.com/gtag/js?id=G-J6JYPJQMXX"></script>
    <script>
        window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
        gtag('config', 'G-J6JYPJQMXX');
    </script>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <style>
        .account-container {
            max-width: 800px;
            margin: 0 auto;
            padding: 40px 24px;
        }

        .account-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 32px;
        }

        .account-header h1 {
            font-size: 1.8rem;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 16px;
        }

        .user-avatar {
            width: 48px;
            height: 48px;
            border-radius: 50%;
            background: var(--primary-light);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            color: var(--primary);
        }

        .user-avatar img {
            width: 100%;
            height: 100%;
            border-radius: 50%;
            object-fit: cover;
        }

        .user-details h2 {
            font-size: 1.1rem;
            margin-bottom: 2px;
        }

        .user-details p {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .account-section {
            background: var(--bg);
            border-radius: var(--radius-lg);
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
        }

        .account-section h3 {
            font-size: 1.1rem;
            margin-bottom: 16px;
            padding-bottom: 12px;
            border-bottom: 1px solid var(--border);
        }

        .info-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
        }

        .info-item label {
            display: block;
            font-size: 0.8rem;
            color: var(--text-light);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-bottom: 4px;
        }

        .info-item p {
            font-weight: 500;
        }

        .orders-list {
            display: flex;
            flex-direction: column;
            gap: 16px;
        }

        .order-card {
            border: 1px solid var(--border);
            border-radius: var(--radius);
            padding: 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 16px;
        }

        .order-info h4 {
            font-size: 1rem;
            margin-bottom: 4px;
        }

        .order-info p {
            color: var(--text-light);
            font-size: 0.9rem;
        }

        .order-meta {
            text-align: right;
        }

        .order-meta .price {
            font-size: 1.2rem;
            font-weight: 600;
            color: var(--primary);
        }

        .order-meta .date {
            font-size: 0.85rem;
            color: var(--text-light);
        }

        .order-actions {
            display: flex;
            gap: 8px;
        }

        .empty-orders {
            text-align: center;
            padding: 40px;
            color: var(--text-light);
        }

        .empty-orders p {
            margin-bottom: 16px;
        }

        .login-prompt {
            text-align: center;
            padding: 60px 24px;
        }

        .login-prompt h2 {
            margin-bottom: 16px;
        }

        .login-prompt p {
            color: var(--text-light);
            margin-bottom: 24px;
        }

        @media (max-width: 600px) {
            .order-card {
                flex-direction: column;
                align-items: flex-start;
            }

            .order-meta {
                text-align: left;
            }
        }
    </style>
</head>
<body>
    <header class="header">
        <a href="/" class="logo">
            <span class="logo-icon">&#10084;</span>
            <span class="logo-text">Heartsnaps</span>
        </a>
        <nav class="nav">
            <a href="/">Home</a>
            <a href="track.html">Track Order</a>
            <button class="btn btn-small" id="auth-btn" onclick="handleAuthClick()">Sign In</button>
        </nav>
    </header>

    <!-- Login Prompt (shown when not logged in) -->
    <div id="login-prompt" class="login-prompt" style="display: none;">
        <h2>Sign in to view your account</h2>
        <p>Sign in with Google to see your order history and saved details.</p>
        <button class="btn btn-google" onclick="signInWithGoogle()">
            <svg viewBox="0 0 24 24" width="20" height="20"><path fill="#4285F4" d="M22.56 12.25c0-.78-.07-1.53-.2-2.25H12v4.26h5.92c-.26 1.37-1.04 2.53-2.21 3.31v2.77h3.57c2.08-1.92 3.28-4.74 3.28-8.09z"/><path fill="#34A853" d="M12 23c2.97 0 5.46-.98 7.28-2.66l-3.57-2.77c-.98.66-2.23 1.06-3.71 1.06-2.86 0-5.29-1.93-6.16-4.53H2.18v2.84C3.99 20.53 7.7 23 12 23z"/><path fill="#FBBC05" d="M5.84 14.09c-.22-.66-.35-1.36-.35-2.09s.13-1.43.35-2.09V7.07H2.18C1.43 8.55 1 10.22 1 12s.43 3.45 1.18 4.93l2.85-2.22.81-.62z"/><path fill="#EA4335" d="M12 5.38c1.62 0 3.06.56 4.21 1.64l3.15-3.15C17.45 2.09 14.97 1 12 1 7.7 1 3.99 3.47 2.18 7.07l3.66 2.84c.87-2.6 3.3-4.53 6.16-4.53z"/></svg>
            Continue with Google
        </button>
    </div>

    <!-- Account Content (shown when logged in) -->
    <div id="account-content" class="account-container" style="display: none;">
        <div class="account-header">
            <h1>My Account</h1>
            <div class="user-info">
                <div class="user-avatar" id="user-avatar">
                    <!-- Avatar or initial -->
                </div>
                <div class="user-details">
                    <h2 id="user-name">Loading...</h2>
                    <p id="user-email"></p>
                </div>
            </div>
        </div>

        <div class="account-section">
            <h3>Saved Details</h3>
            <div class="info-grid" id="saved-details">
                <div class="info-item">
                    <label>Phone</label>
                    <p id="info-phone">-</p>
                </div>
                <div class="info-item">
                    <label>Email</label>
                    <p id="info-email">-</p>
                </div>
                <div class="info-item">
                    <label>Default Address</label>
                    <p id="info-address">-</p>
                </div>
            </div>
        </div>

        <div class="account-section">
            <h3>Order History</h3>
            <div class="orders-list" id="orders-list">
                <!-- Orders loaded here -->
            </div>
        </div>

        <div class="account-section">
            <h3>Account Actions</h3>
            <button class="btn btn-outline" onclick="signOut()">Sign Out</button>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script>
        let supabaseClient = null;
        let currentUser = null;

        document.addEventListener('DOMContentLoaded', async () => {
            await initAccount();
        });

        async function initAccount() {
            try {
                const response = await fetch('/api/config');
                const config = await response.json();

                supabaseClient = window.supabase.createClient(config.supabaseUrl, config.supabaseAnonKey);

                const { data: { session } } = await supabaseClient.auth.getSession();

                if (session) {
                    currentUser = session.user;
                    showAccountContent();
                    loadAccountData();
                } else {
                    showLoginPrompt();
                }

                supabaseClient.auth.onAuthStateChange((event, session) => {
                    if (session) {
                        currentUser = session.user;
                        showAccountContent();
                        loadAccountData();
                    } else {
                        currentUser = null;
                        showLoginPrompt();
                    }
                });

            } catch (err) {
                console.error('Init error:', err);
                showLoginPrompt();
            }
        }

        function showLoginPrompt() {
            document.getElementById('login-prompt').style.display = 'block';
            document.getElementById('account-content').style.display = 'none';
            document.getElementById('auth-btn').textContent = 'Sign In';
            document.getElementById('auth-btn').onclick = () => signInWithGoogle();
        }

        function showAccountContent() {
            document.getElementById('login-prompt').style.display = 'none';
            document.getElementById('account-content').style.display = 'block';
            document.getElementById('auth-btn').textContent = 'Account';
        }

        async function loadAccountData() {
            if (!currentUser) return;

            // Set user info from Google
            const meta = currentUser.user_metadata;
            document.getElementById('user-name').textContent = meta.full_name || meta.name || 'User';
            document.getElementById('user-email').textContent = currentUser.email;

            // Set avatar
            const avatarEl = document.getElementById('user-avatar');
            if (meta.avatar_url || meta.picture) {
                avatarEl.innerHTML = `<img src="${meta.avatar_url || meta.picture}" alt="Avatar">`;
            } else {
                avatarEl.textContent = (meta.full_name || meta.name || 'U').charAt(0).toUpperCase();
            }

            // Load customer data from database
            try {
                const response = await fetch('/api/customer/lookup', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email: currentUser.email })
                });

                if (response.ok) {
                    const data = await response.json();

                    if (data.customer) {
                        document.getElementById('info-phone').textContent = data.customer.phone || '-';
                        document.getElementById('info-email').textContent = data.customer.email || currentUser.email;

                        if (data.customer.address && data.customer.address.line1) {
                            const addr = data.customer.address;
                            document.getElementById('info-address').textContent =
                                `${addr.line1}${addr.line2 ? ', ' + addr.line2 : ''}, ${addr.city} ${addr.state} ${addr.postcode}`;
                        }
                    }

                    if (data.orders && data.orders.length > 0) {
                        renderOrders(data.orders);
                    } else {
                        document.getElementById('orders-list').innerHTML = `
                            <div class="empty-orders">
                                <p>You haven't placed any orders yet.</p>
                                <a href="/" class="btn">Create Your First Magnets</a>
                            </div>
                        `;
                    }
                } else {
                    document.getElementById('orders-list').innerHTML = `
                        <div class="empty-orders">
                            <p>You haven't placed any orders yet.</p>
                            <a href="/" class="btn">Create Your First Magnets</a>
                        </div>
                    `;
                }
            } catch (err) {
                console.error('Load account data error:', err);
            }
        }

        function renderOrders(orders) {
            const container = document.getElementById('orders-list');

            container.innerHTML = orders.map(order => `
                <div class="order-card">
                    <div class="order-info">
                        <h4>${order.order_number}</h4>
                        <p>${order.quantity} ${order.product_type} magnet${order.quantity > 1 ? 's' : ''}</p>
                        <span class="status-badge ${order.status}">${formatStatus(order.status)}</span>
                    </div>
                    <div class="order-meta">
                        <div class="price">$${(order.total / 100).toFixed(2)}</div>
                        <div class="date">${formatDate(order.created_at)}</div>
                    </div>
                    <div class="order-actions">
                        <a href="track.html?order=${order.order_number}" class="btn btn-small btn-outline">Track</a>
                    </div>
                </div>
            `).join('');
        }

        function formatStatus(status) {
            const labels = {
                pending: 'Pending',
                paid: 'Paid',
                printing: 'Printing',
                shipped: 'Shipped',
                ready_pickup: 'Ready for Pickup',
                completed: 'Completed',
                cancelled: 'Cancelled'
            };
            return labels[status] || status;
        }

        function formatDate(dateStr) {
            return new Date(dateStr).toLocaleDateString('en-AU', {
                day: 'numeric',
                month: 'short',
                year: 'numeric'
            });
        }

        async function signInWithGoogle() {
            const { error } = await supabaseClient.auth.signInWithOAuth({
                provider: 'google',
                options: {
                    redirectTo: 'https://heartsnaps.vercel.app/account.html'
                }
            });

            if (error) {
                console.error('Sign in error:', error);
                alert('Sign in failed: ' + error.message);
            }
        }

        async function signOut() {
            await supabaseClient.auth.signOut();
            window.location.href = '/';
        }

        function handleAuthClick() {
            if (currentUser) {
                // Already on account page
            } else {
                signInWithGoogle();
            }
        }
    </script>
</body>
</html>
